KonačnoRadeSobe – Forenzički priručnik
=====================================

0. Kontekst i cilj
------------------
Korisnici na Thesari objavljuju mini React aplikacije koje podatke čuvaju isključivo u localStorage-u. Da bi takve aplikacije radile "copy → publish → multi-device", morali smo:

1. Interceptirati sve pozive `localStorage` (i po potrebi `sessionStorage`) unutar iframea u kojem Play pokreće aplikaciju.
2. Svaku promjenu liste (ili bilo kojeg ključa u `localStorage`u) slati na `/api/storage?ns=app:<listingId>` uz `Authorization`, `X-Thesara-App-Id`, `X-Thesara-Scope: shared` i `If-Match` ETag.
3. Kod učitavanja iframea odmah napuniti cache snimkom sa servera kako drugi preglednik dobije identičan `localStorage` i ne vidi "Soba ne postoji".
4. Zatvoriti sve rupe: direktno otvaranje `/builds` izvan Playa, nedostupan token u standalone režimu, dvostruki `/api//` u URL-u, session-leak (drugi tab ulazi u zadnju sobu), keširani shimovi itd.

Ovaj dokument opisuje svaki problem, konačna rješenja i redoslijed koraka potreban da "sobe" stvarno rade.


1. Glavni dijelovi sustava
--------------------------

1.1. Publish pipeline (`apps/api/src/routes/publish.ts`)
- Linije 249–266 i 374+ ubacuju skriptu u svaki build:
  ```
  <script>
    window.__THESARA_APP_NS = 'app:<listingId>';
    window.__THESARA_APP_ID__ = '<listingId>';
    window.__THESARA_API_BASE__ = '<PUBLIC_BASE>/api';
    window.__THESARA_PLAY_URL__ = '<webBase>/play/<listingId>/?run=1';
    window.thesara = window.thesara || {};
    window.thesara.app = { id: '<listingId>' };
  </script>
  <script type="module" src="/shims/rooms.js?v=<buildId>"></script>
  <script type="module" src="/shims/storage.js?v=<buildId>"></script>
  <script src="/shims/localstorage.js?v=<buildId>"></script>
  ```
- `?v=<buildId>` forsira browser da povuče novu verziju shimova kada objavimo novi build.
- Ako korisnik zalijepi kompletan HTML (`body.inlineCode`), isti blok se ubrizgava kroz `inject` string – po potrebi ga dodatno doradimo da sadrži `?v=`.

1.2. Play iframe host (`apps/web/app/play/[appId]/PlayPageClient.tsx`)
Glavne faze:
- **Bootstrap** (linije ~70–170): čita `appId`, dohvaća JWT ili ga uzima iz `?token`, poziva `fetchSnapshot` iz `apps/web/lib/storage/snapshot-loader.ts` i tek nakon toga postavlja `iframe.src`. Time iframe nikad ne krene s praznim `localStorage`om.
- **PostMessage protokol** (linije 176–360):
  - Kreira capability (random 16 bajtova) i šalje djetetu `thesara:storage:init` (linija 321) sa snapshotom i tokenom.
  - Prima `thesara:storage:flush` i šalje PATCH na `/api/storage?ns=app:<id>` (linije 214+). Ako PATCH padne s 412, loader radi GET i ponovno primjenjuje batch.
  - Nakon uspješnog PATCH-a šalje `thesara:shim:ack` i broadcasta snapshot (`BroadcastChannel`) kako bi svi tabovi vidjeli promjenu.
  - Na `beforeunload` šalje `thesara:storage:flush-now` kako ništa ne bi ostalo u limbu.

1.3. Snapshot loader (`apps/web/lib/storage/snapshot-loader.ts`)
- `fetchSnapshot` i `patchStorage` rade GET/PATCH prema `/api/storage?ns=app:<id>`.
- Headeri: `Authorization: Bearer <firebase jwt>`, `X-Thesara-App-Id: <id>`, `X-Thesara-Scope: shared`, `If-Match: "<etag>"`.
- Ako PATCH vrati 412, loader automatski radi GET, ažurira `storageVersionRef` i ponavlja batch (optimistic locking).

1.4. localStorage bridge shim (`apps/api/src/shims/localStorageBridge.ts`)
- **STANDALONE vs iframe** (linije 4–70): u standalone režimu (netko otvori `/builds/...` direktno) shim prikazuje overlay, upozorenje i pokušava prebaciti korisnika u Play (`window.__THESARA_PLAY_URL__`).
- **Cache + batching** (linije 69–155): interceptira `window.localStorage` i `window.sessionStorage`, vodi Map cache i offline queue.
- **Session više ne ide na server** (linije 166–210): `createFacade('session', false)` onemogućuje enqueuing za session scope, a `applySnapshot('session', …)` je noop. Time `shopping/session/v1` ostaje lokalni i korisnik svaki put vidi prompt.
- **Flush** (linije 102–155):
  - Standalone → `directSync(batch)` (linije 344–409).
  - Iframe → ako CAP nije spreman, ali `getJwtToken()` postoji, shim radi `directSync` kako bi prvi upis bio na serveru; inače šalje parentu `thesara:storage:flush` i čeka `thesara:shim:ack`.
- **Handshake**: sluša `thesara:storage:init`, `thesara:storage:sync`, `thesara:shim:ack`, `thesara:storage:flush-now`.
- **Token i API base** (linije 274–350): `getJwtToken()` prvo čita vlastiti query string, zatim `document.referrer`. `buildApiUrl` uklanja višak `api/` i sprječava `/api//storage`.
- **Direct sync**: PATCH/GET petlja s 3 pokušaja, ažurira `VERSION` (ETag), a batch vraća u queue ako mreža padne.

1.5. storage shim (`apps/api/src/shims/storageClient.ts`)
- Exponira `window.storage` API (rooms/preview koriste ovaj shim).
- `buildApiUrl` normalizira bazu baš kao i localStorage shim.
- `window.addEventListener('message', …)` sluša `thesara:storage:init` kako bi znao namespace/token.

1.6. API storage route (`apps/api/src/routes/storage.ts`)
- `requireRole('user')` (dev fallback u `apps/api/src/middleware/auth.ts` postavlja `dev-user`).
- GET vraća JSON + `ETag` u headeru, PATCH očekuje batch (max 100) i `If-Match` – inače 400.
- Stanje se upisuje u `storage/kv/app-<id>.json` (+ `.meta` ETag).

1.7. Guardovi
- `/builds/:buildId/build/` se blokira u `apps/api/src/routes/public.ts` (linije 23–60) i vraća HTML s gumbom "Otvori u Play" + automatskim redirectom.
- Shim overlay također detektira `missing_token` i prikazuje upozorenje.


2. Popis problema i rješenja
----------------------------
1. Local-only demo → riješeno spremanjem u `/api/storage` kroz shim + Play handshake.
2. Race (iframe čita prazan cache) → iframe src se postavlja tek nakon `fetchSnapshot`; shim radi `bootstrapStandalone()` čim vidi token.
3. Standalone load (`/builds/...`) → overlay + redirect + guard u `public.ts`.
4. Direct sync fallback → kada CAP nije spreman, shim radi PATCH direktno prema API-ju.
5. Token iz referrera → `getJwtToken()` sada čita i `document.referrer`.
6. Double slash (`/api//storage`) → novi `buildApiUrl` u oba shima.
7. Cache busting → publish injektira `?v=<buildId>`.
8. Template escaping → export preko `String.raw`, `catch (e)` umjesto praznih `catch {}`.
9. Session leak → `createFacade('session', false)` i `applySnapshot('session', …)` ignoriraju session scope.
10. Dev-auth 401 → fallback na `dev-user` ako Firebase Admin nije konfiguriran.


3. Operativni koraci – Kako pokrenuti "sobe"
-------------------------------------------
**Lokalno:**
1. `cd apps/api && npm run dev` (port 8789).
2. `cd apps/web && npm run dev:local` (port 3000, proxy prema 8789).
3. Objavi aplikaciju (Publish App → zalijepi React kod → dobiješ `listingId`).
4. Otvori Play URL `http://localhost:3000/play/<listingId>/?run=1&token=<...>` u Pregledniku A i B.
5. U A kreiraj sobu (npr. 2222). U Network tabu moraš vidjeti `PATCH /api/storage?ns=app:<listingId>` = 200/201.
6. U B samo osvježi – prvi `GET /api/storage?ns=app:<listingId>` vraća 200 s JSON-om koji sadrži `shopping/rooms/v1`.

**Produkcija / republish:**
- Svaki put kad se shim promijeni → republishaj app (jer `?v=<buildId>` osigurava novu verziju).
- Ako vidiš `404 /shims/...`, API nije restartan ili build još nije dostupan.
- Stanje provjeri u `storage/kv/app-<id>.json`.

**Verifikacija:**
- `curl -H "Authorization: Bearer <token>" -H "X-Thesara-App-Id: <id>" -H "X-Thesara-Scope: shared" http://127.0.0.1:8789/api/storage?ns=app:<id>`
- `storage/kv/app-<id>.json` mora sadržavati `shopping/rooms/v1`.


4. Troubleshooting matrica
--------------------------
| Simptom | Uzrok | Provjera | Rješenje |
| --- | --- | --- | --- |
| `localstorage.js:295 Unexpected token '}'` | Stara verzija šima (bez `String.raw`) | Otvori `/shims/localstorage.js?v=999` i provjeri regex | Restart API + republish |
| `Failed to load resource /shims/...` | Build bez `?v=<id>` ili API nije restartan | Network tab → 404 | Restart i republish |
| `GET /api/storage ... 401` | Nema valjanog Firebase tokena | Pogledaj log `apps/api/src/middleware/auth.ts` | U dev-u fallback radi automatski; u produkciji konfiguriraj Firebase Admin |
| `PATCH /api/storage ... 412` | ETag mismatch (drugi uređaj je već zapisao) | Response 412 + `ETag` | Pričekaj roditeljski retri (automatski) ili ručno osvježi |
| Drugi preglednik odmah otvara zadnju sobu | Session scope se sinka | `storage/kv/app-*.json` sadrži `shopping/session/v1` | Nakon patcha (sessionFacade bez synca) republish aplikaciju |
| Aplikacija radi samo u jednom tabu | CAP se ne šalje (postMessage blokiran) | Console `thesara:shim:ready` se ne pojavljuje | Provjeri CSP i `sandbox` (`allow-same-origin`) |


5. Kronologija fixeva
----------------------
1. Intercept `localStorage` + Play handshake.
2. Gating iframe src + eager bootstrap.
3. Standalone overlay + guard.
4. Direct sync fallback kad CAP kasni.
5. Token iz referrera.
6. Normalizacija `buildApiUrl`.
7. Cache busting (`?v=`).
8. `String.raw` + `catch (e)`.
9. Session scope lokalni.
10. Dev auth fallback.


6. Zaključak
------------
Kombinacijom Play hosta, shimova i storage API-ja sada imamo experience u kojem korisnik ne mora mijenjati svoj localStorage demo – sve radi kroz Thesara infrastrukturu. Svaki korak (od publish pipelinea do `storage/kv` zapisa) opisan je u ovom priručniku i služi kao referenca za buduća održavanja i nadogradnje.
